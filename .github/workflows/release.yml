name: Build and Release

# 触发条件：当推送以 'v' 开头的标签时（例如 v1.0.1）
on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        # 同时在 macOS 和 Windows 虚拟机上运行
        os: [macos-latest, windows-latest]

    steps:
      # 1. 拉取代码
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. 安装 Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20 # 推荐使用 20 (LTS) 或 22
          cache: 'yarn'

      # 3. 安装依赖
      # 使用 --frozen-lockfile 确保安装版本与 yarn.lock 完全一致
      - name: Install Dependencies
        run: yarn install --frozen-lockfile

      # 4. 执行打包命令
      # ⚠️ 重点修改：这里执行 package.json 中的 "build" 脚本
      # 在 Mac 机器上，它会执行 node scripts/build.mjs && electron-forge make (生成 dmg/zip)
      # 在 Win 机器上，它会执行 node scripts/build.mjs && electron-forge make (生成 exe/zip)
      - name: Build / Make
        run: yarn build

      # 5. 发布并上传文件
      - name: Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          # 自动匹配 out 文件夹下的产物
          # 如果你的 electron-forge 配置修改了输出目录，请同步修改这里
          files: |
            out/**/*.exe
            out/**/*.dmg
            out/**/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}